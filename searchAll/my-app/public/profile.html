<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پروفایل کاربر</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="video-player.css">
    <style>
        .profile-pic {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img id="profilePic" src="https://via.placeholder.com/120x120?text=Avatar" class="profile-pic mb-3">
                        <form id="profilePicForm" enctype="multipart/form-data">
                            <input type="file" id="profilePicInput" name="profilePic" accept="image/*" class="form-control mb-2">
                            <button type="submit" class="btn btn-outline-info btn-sm">تغییر تصویر</button>
                        </form>
                        <h4 id="userName">نام کاربر</h4>
                        <p id="userEmail" class="text-muted"></p>
                        <button class="btn btn-outline-primary btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">ویرایش اطلاعات</button>
                        <button class="btn btn-outline-secondary btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">تغییر رمز عبور</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-graduation-cap me-2"></i>دوره‌های من</div>
                    <div class="card-body" id="myCourses"></div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-shopping-cart me-2"></i>خریدهای من</div>
                    <div class="card-body" id="myOrders"></div>
                </div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-video me-2"></i>ویدئوهای من</div>
                    <div class="card-body" id="myVideos"></div>
                    <div id="uploadLimitInfo" class="m-3 text-muted"></div>
                </div>
                <!-- بخش تنظیمات امنیتی -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt text-warning me-2"></i>تنظیمات امنیتی</h5>
                    </div>
                    <div class="card-body">
                        <!-- احراز هویت دو مرحله‌ای -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6>احراز هویت دو مرحله‌ای</h6>
                                <small class="text-muted">افزایش امنیت حساب کاربری با کد تایید</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="twoFactorToggle">
                                <label class="form-check-label" for="twoFactorToggle">
                                    <span id="twoFactorStatus">غیرفعال</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- فرم فعال‌سازی 2FA -->
                        <div id="twoFactorForm" style="display:none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                برای فعال‌سازی احراز هویت دو مرحله‌ای، رمز عبور خود را وارد کنید
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="password" class="form-control" id="twoFactorPassword" placeholder="رمز عبور">
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-primary" onclick="toggleTwoFactor()">
                                        <i class="fas fa-shield-alt me-2"></i>فعال‌سازی
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- تغییر رمز عبور -->
                        <hr>
                        <h6>تغییر رمز عبور</h6>
                        <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key me-2"></i>تغییر رمز عبور
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ویرایش اطلاعات -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ویرایش اطلاعات کاربری</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label class="form-label">نام</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ایمیل</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal تغییر رمز -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تغییر رمز عبور</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">رمز فعلی</label>
                            <input type="password" class="form-control" id="oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">رمز جدید</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <button type="submit" class="btn btn-success">تغییر رمز</button>
        </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('authToken');
        if (!token) {
            document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">برای مشاهده پروفایل ابتدا وارد شوید.</div></div>';
            return;
        }
        // دریافت اطلاعات کاربر
        const res = await fetch('/api/profile', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
            document.getElementById('userName').textContent = data.user.name || '---';
            document.getElementById('userEmail').textContent = data.user.email;
            document.getElementById('editName').value = data.user.name || '';
            document.getElementById('editEmail').value = data.user.email || '';
            document.getElementById('profilePic').src = data.user.profilePic ? '/uploads/' + data.user.profilePic : 'https://via.placeholder.com/120x120?text=Avatar';
        }
        // لیست دوره‌های کاربر
        const resCourses = await fetch('/api/my-courses', { headers: { 'Authorization': `Bearer ${token}` } });
        const dataCourses = await resCourses.json();
        if (dataCourses.success) {
            const container = document.getElementById('myCourses');
            if (dataCourses.courses.length === 0) {
                container.innerHTML = '<div class="text-muted">در دوره‌ای ثبت‌نام نکرده‌اید.</div>';
            } else {
                container.innerHTML = dataCourses.courses.map(c => `
                    <div class="mb-2 p-2 border rounded d-flex align-items-center">
                        <img src="${c.image || 'https://via.placeholder.com/60x60'}" class="me-2" style="width:60px;height:60px;object-fit:cover;border-radius:10px;">
                        <div class="flex-grow-1">
                            <b>${c.title}</b><br>
                            <span class="text-muted small">پیشرفت: ${c.progress_percent || 0}%</span>
                        </div>
                        <a href="/course-detail.html?id=${c.id}" class="btn btn-outline-primary btn-sm">مشاهده</a>
                    </div>
                `).join('');
            }
        }
        // لیست خریدها
        const resOrders = await fetch('/api/my-orders', { headers: { 'Authorization': `Bearer ${token}` } });
        const dataOrders = await resOrders.json();
        if (dataOrders.success) {
            const container = document.getElementById('myOrders');
            if (dataOrders.orders.length === 0) {
                container.innerHTML = '<div class="text-muted">خریدی ثبت نشده است.</div>';
            } else {
                container.innerHTML = dataOrders.orders.map(o => `
                    <div class="mb-2 p-2 border rounded d-flex align-items-center">
                        <i class="fas fa-receipt fa-2x text-info me-2"></i>
                        <div class="flex-grow-1">
                            <b>سفارش #${o.id}</b><br>
                            <span class="text-muted small">${o.createdAt ? new Date(o.createdAt).toLocaleDateString('fa-IR') : ''}</span>
                        </div>
                        <span class="badge bg-success">${o.status}</span>
                    </div>
                `).join('');
            }
        }
        // دریافت ویدئوهای کاربر
        const res2 = await fetch('/api/my-videos', { headers: { 'Authorization': `Bearer ${token}` } });
        const data2 = await res2.json();
        if (data2.success) {
            const grid = document.getElementById('myVideos');
            if (data2.videos.length === 0) {
                grid.innerHTML = '<div class="text-muted">ویدئویی آپلود نکرده‌اید.</div>';
            } else {
                grid.innerHTML = data2.videos.map(v => `
                    <div class="video-card">
                        <div class="video-thumbnail">
                            <img src="${v.thumbnail ? '/uploads/' + v.thumbnail : 'https://via.placeholder.com/300x200/333/fff?text=ویدئو'}" style="width:100%;height:150px;object-fit:cover;">
                        </div>
                        <div class="video-info">
                            <div class="video-title">${v.title}</div>
                            <div class="video-meta">${v.createdAt ? new Date(v.createdAt).toLocaleDateString('fa-IR') : ''}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        // محدودیت آپلود روزانه
        const today = new Date();
        today.setHours(0,0,0,0);
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const count = data2.videos.filter(v => new Date(v.createdAt) >= today && new Date(v.createdAt) < tomorrow).length;
        document.getElementById('uploadLimitInfo').innerHTML = `تعداد آپلود امروز: <b>${count}</b> / 5`;

        // ویرایش اطلاعات
        document.getElementById('editProfileForm').onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const res = await fetch('/api/profile/edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, email })
            });
            const data = await res.json();
            if (data.success) {
                alert('اطلاعات با موفقیت ویرایش شد');
                location.reload();
            } else {
                alert('خطا در ویرایش اطلاعات');
            }
        };
        // تغییر رمز عبور
        document.getElementById('changePasswordForm').onsubmit = async function(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const res = await fetch('/api/profile/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ oldPassword, newPassword })
            });
            const data = await res.json();
            if (data.success) {
                alert('رمز عبور با موفقیت تغییر کرد');
                document.getElementById('changePasswordForm').reset();
                var modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
            } else {
                alert(data.message || 'خطا در تغییر رمز عبور');
            }
        };
        document.getElementById('profilePicForm').onsubmit = async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('profilePicInput');
            if (!fileInput.files.length) return alert('لطفا یک تصویر انتخاب کنید');
            const formData = new FormData();
            formData.append('profilePic', fileInput.files[0]);
            const res = await fetch('/api/profile/upload-pic', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                alert('تصویر با موفقیت تغییر کرد');
                document.getElementById('profilePic').src = '/uploads/' + data.filename + '?t=' + Date.now();
            } else {
                alert(data.message || 'خطا در تغییر تصویر');
            }
        };

        // بارگذاری اطلاعات پروفایل
        async function loadProfile() {
            try {
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userEmail').textContent = user.email;
                    if (user.profilePic) {
                        document.getElementById('profilePic').src = '/uploads/' + user.profilePic;
                    }
                    
                    // به‌روزرسانی وضعیت 2FA
                    updateTwoFactorStatus(user.twoFactorEnabled);
                }
            } catch (error) {
                console.error('خطا در بارگذاری پروفایل:', error);
            }
        }

        // به‌روزرسانی وضعیت 2FA
        function updateTwoFactorStatus(enabled) {
            const toggle = document.getElementById('twoFactorToggle');
            const status = document.getElementById('twoFactorStatus');
            const form = document.getElementById('twoFactorForm');
            
            toggle.checked = enabled;
            status.textContent = enabled ? 'فعال' : 'غیرفعال';
            status.className = enabled ? 'text-success' : 'text-muted';
            
            if (enabled) {
                form.style.display = 'none';
            }
        }

        // مدیریت تغییر وضعیت 2FA
        document.getElementById('twoFactorToggle').addEventListener('change', function() {
            const form = document.getElementById('twoFactorForm');
            if (this.checked) {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                // غیرفعال کردن 2FA
                toggleTwoFactor(false);
            }
        });

        // فعال/غیرفعال کردن 2FA
        async function toggleTwoFactor(enable = true) {
            const password = document.getElementById('twoFactorPassword').value;
            
            if (!password) {
                alert('لطفا رمز عبور را وارد کنید');
                return;
            }
            
            try {
                const response = await fetch('/api/profile/toggle-2fa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ enable, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    updateTwoFactorStatus(enable);
                    document.getElementById('twoFactorPassword').value = '';
                    document.getElementById('twoFactorForm').style.display = 'none';
                    document.getElementById('twoFactorToggle').checked = enable;
                } else {
                    alert(data.message || 'خطا در تغییر وضعیت');
                }
            } catch (error) {
                console.error('خطا در تغییر وضعیت 2FA:', error);
                alert('خطا در ارتباط با سرور');
            }
            }
        });
    </script>
</body>
</html> 